<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AIG Endoscopy Report</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: Inter, system-ui, sans-serif; }
    .loc-column { min-height: 320px; max-height: 420px; overflow:auto; }
    .pill, .attr-pill {
      cursor:pointer; border:1px solid #93c5fd; background:#fff;
      color:#1e40af; padding:.35rem .6rem; border-radius:.5rem;
      font-size:.875rem; transition:all .15s;
    }
    .pill:hover, .attr-pill:hover { background:#eff6ff; }
    .pill-selected, .attr-pill.selected {
      background:#2563eb; color:#fff; border-color:#1d4ed8;
    }
    .left-disease {
      display:block; text-align:left; width:100%;
      padding:.5rem .75rem; border-radius:.5rem;
      border:1px solid transparent; background:#fff; color:#1f2937;
    }
    .left-disease:hover { background:#f1f5f9; }
    .left-disease.selected {
      background:#2563eb; color:#fff; border-color:#1e40af;
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-800">
<div class="max-w-full mx-auto p-6">
  <h1 class="text-2xl font-bold text-center text-blue-700 mb-6">AIG Endoscopy Report</h1>

  <div class="mb-3 flex items-center justify-between gap-4">
    <div class="text-sm text-gray-600">Load CSV mapping (select your CSV):</div>
    <div class="flex items-center gap-2">
      <input id="csvFile" type="file" accept=".csv" class="text-sm" />
      <button id="loadSample" class="px-3 py-1 rounded border text-sm bg-white hover:bg-gray-50">Load sample</button>
      <div id="csvNote" class="text-sm text-yellow-700"></div>
    </div>
  </div>

  <div class="flex gap-6">
    <!-- LEFT -->
    <div class="w-3/4 space-y-4">
      <div class="bg-white p-4 rounded shadow">
        <div class="grid grid-cols-4 gap-4">
          <div>
            <h3 class="text-blue-600 font-semibold mb-2">Esophagus</h3>
            <div id="col-esophagus" class="loc-column space-y-2"></div>
          </div>
          <div>
            <h3 class="text-blue-600 font-semibold mb-2">GE Junction</h3>
            <div id="col-gejunction" class="loc-column space-y-2"></div>
          </div>
          <div>
            <h3 class="text-blue-600 font-semibold mb-2">Gastric</h3>
            <div id="col-stomach" class="loc-column space-y-2"></div>
          </div>
          <div>
            <h3 class="text-blue-600 font-semibold mb-2">Duodenum</h3>
            <div id="col-duodenum" class="loc-column space-y-2"></div>
          </div>
        </div>
        <div class="mt-4 bg-blue-50 p-4 rounded">
          <div class="font-medium mb-2 text-sm text-gray-700">
            Sub-Location <span class="text-xs italic text-gray-500">(multi-select)</span>
          </div>
          <div id="subloc-chips" class="flex gap-2 flex-wrap"></div>
        </div>
      </div>

      <div id="detailsCard" class="bg-white p-4 rounded shadow hidden">
        <div class="flex justify-between items-center mb-3">
          <div>
            <div class="text-lg font-semibold" id="detailsTitle">Details</div>
            <div class="text-sm text-gray-500" id="detailsSubTitle"></div>
          </div>
          <button id="closeDetails" class="px-3 py-1 border rounded text-sm">Close</button>
        </div>
        <div id="detailsSections" class="space-y-4"></div>
        <div class="mt-4">
          <label class="block font-medium mb-1">Additional Comments</label>
          <textarea id="diseaseComments" rows="3" class="w-full p-2 border rounded" placeholder="Comments..."></textarea>
        </div>
      </div>
    </div>

    <!-- RIGHT -->
    <div class="w-1/4">
      <div class="bg-white p-4 rounded shadow">
        <div class="flex justify-between items-center mb-3">
          <h2 class="text-lg font-semibold">Report</h2>
          <div class="flex gap-2">
            <button id="downloadJSON" class="bg-green-600 text-white px-3 py-1 rounded text-sm">Download JSON</button>
            <button id="loadSavedJSON" class="bg-blue-600 text-white px-3 py-1 rounded text-sm">Load Saved JSON</button>
            <button id="clearReport" class="bg-red-600 text-white px-3 py-1 rounded text-sm">Clear</button>
          </div>
        </div>
        <div id="reportContent" class="space-y-4 min-h-[40vh]"></div>
      </div>
      <div class="bg-white mt-4 p-4 rounded shadow">
        <label class="block font-medium mb-1">Overall Remarks</label>
        <textarea id="overallRemarks" rows="4" class="w-full p-2 border rounded" placeholder="Overall remarks"></textarea>
      </div>
    </div>
  </div>
</div>

<input id="jsonFile" type="file" accept="application/json, .json" style="display:none" />

<script>
/* ---------- CSV parsing ---------- */
function parseCSV(text){
  const rows = [];
  let row = [];
  let cur = "";
  let inQuotes = false;

  for(let i=0;i<text.length;i++){
    const ch = text[i];
    if(ch === '"'){
      if(inQuotes && text[i+1] === '"'){ cur += '"'; i++; continue; }
      inQuotes = !inQuotes;
      continue;
    }
    if(!inQuotes && (ch === "\r" || ch === "\n")){
      if(ch === "\r" && text[i+1] === "\n") i++;
      row.push(cur);
      rows.push(row);
      row = [];
      cur = "";
      continue;
    }
    if(!inQuotes && ch === ","){
      row.push(cur);
      cur = "";
      continue;
    }
    cur += ch;
  }
  if(cur !== "" || row.length){
    row.push(cur);
    rows.push(row);
  }
  if(!rows.length) return [];

  const headers = rows[0].map(h => (h || "").trim());
  return rows.slice(1)
    .filter(r => r.some(c => (c || "").trim()))
    .map(r => {
      const obj = {};
      headers.forEach((h, idx) => {
        obj[h || ("col"+idx)] = (r[idx] || "").trim();
      });
      return obj;
    });
}

function expandRangeToken(t){
  const m = t.match(/^Range\(\s*(-?\d+)\s*,\s*(-?\d+)\s*\)$/i);
  if(!m) return null;
  const start = parseInt(m[1],10);
  const end   = parseInt(m[2],10);
  const arr = [];
  for(let i=start;i<end;i++) arr.push(""+i);
  return arr;
}

function isX(v){ return v && (""+v).toLowerCase().includes("x"); }
function isMultiFlag(v){
  if(!v) return false;
  const s = (""+v).toLowerCase();
  return s.includes("x") || s.includes("yes") || s.includes("multi");
}

/* ---------- hint helper (multiline + images) ---------- */
function createHintElement(text){
  const wrapper = document.createElement("div");
  wrapper.className = "text-xs italic text-gray-500 mb-1";

  // preserve newlines
  const textDiv = document.createElement("div");
  textDiv.className = "whitespace-pre-line";
  textDiv.textContent = text;
  wrapper.appendChild(textDiv);

  // find image filenames in the hint text
  // NOTE: single backslashes, and '-' is correctly escaped as \-
  const imgRegex = /([A-Za-z0-9_.\-\/]+?\.(?:png|jpe?g|webp))/ig;
  const imgs = [];
  let m;
  while ((m = imgRegex.exec(text)) !== null) {
    imgs.push(m[1]);
  }

  if (imgs.length) {
    const imgRow = document.createElement("div");
    imgRow.className = "mt-1 flex flex-wrap gap-2";
    imgs.forEach(fname => {
      const img = document.createElement("img");
      img.src = "pictures/" + fname;
      img.alt = fname;
      img.className = "max-h-32 border rounded";
      imgRow.appendChild(img);
    });
    wrapper.appendChild(imgRow);
  }

  return wrapper;
}

/* ---------- constants ---------- */
const SUBLOCATIONS = {
  'Esophagus':['Cricopharynx','Upper','Middle','Lower','Whole esophagus','Anastomosis'],
  'GE Junction':['Z-line','Hiatal hernia','Diaphragmatic pinch'],
  'Stomach':['Cardia','Fundus','Body','Incisura/angulus','Antrum','Prepyloric region','Pylorus','Whole stomach','Anastomosis','Hiatal hernia','Diaphragma orifice','Greater curve','Lesser curve','Anterior wall','Posterior wall'],
  'Duodenum':['Duodenal bulb(D1)','D2','D3','D4','Upper duodenal knee/ superior duodenal angulus','Ampullary region','Major papilla','Minor papilla','Lower duodenal knee/ inferior duodenal angulus','Anastomosis','Proximal','Distal']
};

let DISEASES = {};
let report = {};
let active = null;
let selectedMainLoc = 'Esophagus';

/* ---------- Build DISEASES model from CSV ---------- */
function buildFromCSV(rows){
  DISEASES = {};
  rows.forEach(r => {
    const d = (r["Diagnosis"] || "").trim();
    if(!d) return;

    if(!DISEASES[d]){
      DISEASES[d] = {
        sections: {},
        locations: {},
        default_subloc: (r["Default_Sub_Location"] || "").trim()
      };
    }

    ["Esophagus","GE Junction","Stomach","Duodenum"].forEach(loc => {
      if(isX(r[loc])) DISEASES[d].locations[loc] = true;
    });

    const sec = (r["Section"] || "General").trim();
    const sub = (r["Subsection"] || "").trim();
    const secHint = (r["Section_Hint"] || "").trim();
    const subHint = (r["Subsection_Hint"] || "").trim();
    const multi = isMultiFlag(r["Multi_Attribute"]);

    if(!DISEASES[d].sections[sec]){
      DISEASES[d].sections[sec] = {
        rows: [],
        subsections: {},
        multi: false,
        hint: secHint || ""
      };
    } else if(secHint && !DISEASES[d].sections[sec].hint){
      DISEASES[d].sections[sec].hint = secHint;
    }

    const secDef = DISEASES[d].sections[sec];

    if(!sub){
      secDef.rows.push(r);
      if(multi) secDef.multi = true;
    } else {
      if(!secDef.subsections[sub]){
        secDef.subsections[sub] = {
          rows: [],
          multi: false,
          hint: subHint || ""
        };
      } else if(subHint && !secDef.subsections[sub].hint){
        secDef.subsections[sub].hint = subHint;
      }
      secDef.subsections[sub].rows.push(r);
      if(multi) secDef.subsections[sub].multi = true;
    }
  });
}

/* ---------- Left columns (diseases) ---------- */
function populateColumns(){
  ["col-esophagus","col-gejunction","col-stomach","col-duodenum"].forEach(id => {
    document.getElementById(id).innerHTML = "";
  });

  Object.keys(DISEASES).forEach(name => {
    const def = DISEASES[name];
    Object.keys(def.locations).forEach(loc => {
      const colId =
        loc === "Esophagus" ? "col-esophagus" :
        loc === "GE Junction" ? "col-gejunction" :
        loc === "Stomach" ? "col-stomach" : "col-duodenum";

      const btn = document.createElement("button");
      btn.className = "left-disease";
      btn.textContent = name;
      btn.dataset.loc = loc;
      btn.dataset.disease = name;

      btn.onclick = () => {
        selectedMainLoc = loc;
        addOrOpenDisease(loc, name);
        refreshLeftHighlights();
      };

      document.getElementById(colId).appendChild(btn);
    });
  });

  refreshLeftHighlights();
}

function refreshLeftHighlights(){
  document.querySelectorAll(".left-disease").forEach(btn => {
    const loc = btn.dataset.loc;
    const dn  = btn.dataset.disease;
    const inReport = !!(report[loc] && report[loc].diseases && report[loc].diseases[dn]);
    const isActive = !!(active && active.loc === loc && active.disease === dn);
    btn.classList.toggle("selected", inReport || isActive);
  });
}

/* ---------- Sub-location chips (multi-select) ---------- */
function renderSubLocChips(){
  const el = document.getElementById("subloc-chips");
  el.innerHTML = "";

  const options = SUBLOCATIONS[selectedMainLoc] || [];
  let current = [];

  if(active && report[active.loc] && report[active.loc].diseases[active.disease]){
    const d = report[active.loc].diseases[active.disease];
    if(Array.isArray(d.sublocations)) current = d.sublocations;
  }

  options.forEach(s => {
    const chip = document.createElement("button");
    chip.className = "pill";
    chip.textContent = s;

    if(current.includes(s)) chip.classList.add("pill-selected");

    chip.onclick = () => {
      if(!active || !report[active.loc] || !report[active.loc].diseases[active.disease]) return;
      const disease = report[active.loc].diseases[active.disease];
      if(!Array.isArray(disease.sublocations)) disease.sublocations = [];

      const idx = disease.sublocations.indexOf(s);
      if(idx >= 0){
        disease.sublocations.splice(idx,1);
        chip.classList.remove("pill-selected");
      } else {
        disease.sublocations.push(s);
        chip.classList.add("pill-selected");
      }

      updateDetailsSubtitle();
      renderReport();
      refreshLeftHighlights();
    };

    el.appendChild(chip);
  });
}

function updateDetailsSubtitle(){
  const el = document.getElementById("detailsSubTitle");
  if(!active || !report[active.loc] || !report[active.loc].diseases[active.disease]){
    el.textContent = "";
    return;
  }
  const d = report[active.loc].diseases[active.disease];
  const subs = Array.isArray(d.sublocations) ? d.sublocations : [];
  el.textContent = "Sub-Locations: " + (subs.length ? subs.join(", ") : "—");
}

/* ---------- disease add/open ---------- */
function addOrOpenDisease(loc, disease){
  if(!report[loc]) report[loc] = { diseases: {} };
  if(!report[loc].diseases[disease]){
    report[loc].diseases[disease] = {
      sections: {},
      comments: "",
      sublocations: []
    };
    const def = DISEASES[disease] && DISEASES[disease].default_subloc;
    if(def){
      report[loc].diseases[disease].sublocations = [def];
    }
  }
  openDetails(loc, disease);
  renderReport();
  refreshLeftHighlights();
}

function openDetails(loc, disease){
  if(!report[loc] || !report[loc].diseases[disease]) return;
  active = { loc, disease };
  selectedMainLoc = loc;

  document.getElementById("detailsCard").classList.remove("hidden");
  document.getElementById("detailsTitle").textContent = disease;

  renderSubLocChips();
  updateDetailsSubtitle();
  renderDetailsSections(disease);

  document.getElementById("diseaseComments").value =
    report[loc].diseases[disease].comments || "";
}

document.getElementById("closeDetails").onclick = () => {
  active = null;
  document.getElementById("detailsCard").classList.add("hidden");
  refreshLeftHighlights();
};

/* ---------- conditional logic ---------- */
function evaluateConditional(cond){
  if(!cond || !cond.trim()) return true;
  const s = cond.trim();

  const locMatch = s.match(/^Location\(\s*Main\s*=\s*(.+?)\s*\)$/i);
  if(locMatch) return selectedMainLoc === locMatch[1];

  const secMatch = s.match(/^Section\(\s*([^=]+?)\s*=\s*(.+?)\s*\)$/i);
  if(secMatch){
    if(!active) return false;
    const m = report[active.loc] && report[active.loc].diseases[active.disease];
    if(!m) return false;
    const sec = m.sections[secMatch[1]];
    return !!(sec && sec.attrs && sec.attrs[secMatch[2]]);
  }

  const subMatch = s.match(/^Subsection\(\s*([^=]+?)\s*=\s*(.+?)\s*\)$/i);
  if(subMatch){
    if(!active) return false;
    const m = report[active.loc] && report[active.loc].diseases[active.disease];
    if(!m) return false;
    const subName = subMatch[1];
    const val = subMatch[2];
    return Object.values(m.sections || {}).some(sec =>
      sec.subsections && sec.subsections[subName] &&
      sec.subsections[subName].attrs &&
      sec.subsections[subName].attrs[val]
    );
  }

  return false;
}

/* ---------- details pane ---------- */
function renderDetailsSections(diseaseName){
  const container = document.getElementById("detailsSections");
  container.innerHTML = "";
  const defs = (DISEASES[diseaseName] && DISEASES[diseaseName].sections) || {};

  Object.keys(defs).forEach(secName => {
    const secDef = defs[secName];

    const box = document.createElement("div");
    box.className = "p-3 border rounded";

    const title = document.createElement("div");
    title.className = "font-semibold mb-1";
    const secMeta = secDef.multi ? "Multi-select" : "Single selection only";
    title.innerHTML = `${secName} <span class="italic text-xs text-gray-500">(${secMeta})</span>`;
    box.appendChild(title);

    if(secDef.hint){
      box.appendChild(createHintElement(secDef.hint));
    }

    (secDef.rows || [])
      .filter(r => !(r["Subsection"] || "").trim())
      .forEach(r => {
        if(!evaluateConditional(r["Conditional_on"])) return;
        box.appendChild(renderRow(r, secName, null));
      });

    Object.keys(secDef.subsections || {}).forEach(subName => {
      const subDef = secDef.subsections[subName];

      const subBox = document.createElement("div");
      subBox.className = "mt-3 p-2 border rounded bg-gray-50";

      const st = document.createElement("div");
      st.className = "font-semibold text-sm mb-1";
      const subMeta = subDef.multi ? "Multi-select" : "Single selection only";
      st.innerHTML = `${subName} <span class="italic text-xs text-gray-500">(${subMeta})</span>`;
      subBox.appendChild(st);

      if(subDef.hint){
        subBox.appendChild(createHintElement(subDef.hint));
      }

      (subDef.rows || []).forEach(r => {
        if(!evaluateConditional(r["Conditional_on"])) return;
        subBox.appendChild(renderRow(r, secName, subName));
      });

      box.appendChild(subBox);
    });

    container.appendChild(box);
  });

  document.getElementById("diseaseComments").oninput = e => {
    if(!active) return;
    report[active.loc].diseases[active.disease].comments = e.target.value;
    renderReport();
  };
}

/* ---------- row rendering (supports multi input boxes) ---------- */
function renderRow(row, secName, subName){
  const wrap = document.createElement("div");
  wrap.className = "mt-2";

  const attrs = Object.keys(row)
    .filter(k => /^Attribute/i.test(k))
    .map(k => row[k])
    .filter(v => v && v.trim());

  const multi = isMultiFlag(row["Multi_Attribute"]);

  attrs.forEach(attrStr => {
    if(/^Range\(/i.test(attrStr)){
      (expandRangeToken(attrStr) || []).forEach(x => {
        wrap.appendChild(makePill(x, secName, subName, multi));
      });
      return;
    }

    if(/int_box|alphanum_box/i.test(attrStr)){
      wrap.appendChild(renderInputAttribute(attrStr, secName, subName));
    } else {
      wrap.appendChild(makePill(attrStr, secName, subName, multi));
    }
  });

  return wrap;
}

/* ---------- multi-input attribute renderer ---------- */
function renderInputAttribute(attrStr, secName, subName){
  const wrap = document.createElement("div");
  wrap.className = "flex items-center flex-wrap gap-2 mt-2";

  const tokens = attrStr.trim().split(/\s+/);
  let buffer = [];
  let boxIndex = 0;

  function flushText(){
    if(!buffer.length) return;
    const span = document.createElement("span");
    span.className = "text-sm";
    span.textContent = buffer.join(" ");
    wrap.appendChild(span);
    buffer = [];
  }

  tokens.forEach(tok => {
    const lower = tok.toLowerCase();
    if(lower === "int_box" || lower === "alphanum_box"){
      flushText();

      const input = document.createElement("input");
      input.type = (lower === "int_box") ? "number" : "text";
      input.className = "border rounded p-1 w-20";

      const rawKey = attrStr + "__" + boxIndex + "__" + lower;

      // prepopulate if exists
      if(active && report[active.loc] && report[active.loc].diseases[active.disease]){
        const model = report[active.loc].diseases[active.disease];
        let inputsRef = null;
        if(subName){
          inputsRef = model.sections?.[secName]?.subsections?.[subName]?.inputs;
        } else {
          inputsRef = model.sections?.[secName]?.inputs;
        }
        if(Array.isArray(inputsRef)){
          const found = inputsRef.find(i => i.rawKey === rawKey);
          if(found) input.value = found.value;
        }
      }

      input.oninput = () => {
        if(!active) return;
        const val = input.value.trim();
        const model = report[active.loc].diseases[active.disease];

        if(!model.sections[secName])
          model.sections[secName] = { attrs:{}, inputs:[], subsections:{} };

        let inputsRef;
        if(subName){
          if(!model.sections[secName].subsections[subName])
            model.sections[secName].subsections[subName] = { attrs:{}, inputs:[] };
          inputsRef = model.sections[secName].subsections[subName].inputs;
        } else {
          inputsRef = model.sections[secName].inputs;
        }

        if(!Array.isArray(inputsRef)){
          if(subName){
            model.sections[secName].subsections[subName].inputs = [];
            inputsRef = model.sections[secName].subsections[subName].inputs;
          } else {
            model.sections[secName].inputs = [];
            inputsRef = model.sections[secName].inputs;
          }
        }

        const existingIdx = inputsRef.findIndex(i => i.rawKey === rawKey);
        if(existingIdx >= 0) inputsRef.splice(existingIdx,1);
        if(val){
          inputsRef.push({
            rawKey,
            value: val,
            label: attrStr + " [" + (boxIndex+1) + "]: " + val
          });
        }
        renderReport();
      };

      wrap.appendChild(input);
      boxIndex++;
    } else {
      buffer.push(tok);
    }
  });

  flushText();
  return wrap;
}

/* ---------- attribute pill ---------- */
function makePill(attr, secName, subName, multi){
  const btn = document.createElement("button");
  btn.className = "attr-pill";
  btn.textContent = attr;

  const m = active && report[active.loc] && report[active.loc].diseases[active.disease];
  if(m){
    const ref = subName
      ? m.sections[secName]?.subsections?.[subName]?.attrs
      : m.sections[secName]?.attrs;
    if(ref && ref[attr]) btn.classList.add("selected");
  }

  btn.onclick = () => {
    if(!active) return;
    const model = report[active.loc].diseases[active.disease];
    if(!model.sections[secName])
      model.sections[secName] = { attrs:{}, inputs:[], subsections:{} };

    if(subName){
      if(!model.sections[secName].subsections[subName])
        model.sections[secName].subsections[subName] = { attrs:{}, inputs:[] };
      const t = model.sections[secName].subsections[subName].attrs;
      if(multi){
        if(t[attr]) delete t[attr]; else t[attr] = true;
      } else {
        Object.keys(t).forEach(k => delete t[k]);
        t[attr] = true;
      }
    } else {
      const t = model.sections[secName].attrs;
      if(multi){
        if(t[attr]) delete t[attr]; else t[attr] = true;
      } else {
        Object.keys(t).forEach(k => delete t[k]);
        t[attr] = true;
      }
    }

    renderDetailsSections(active.disease);
    renderReport();
    refreshLeftHighlights();
  };

  return btn;
}

/* ---------- right-hand report ---------- */
function renderReport(){
  const rc = document.getElementById("reportContent");
  rc.innerHTML = "";

  Object.keys(report).forEach(loc => {
    const blk = document.createElement("div");
    blk.className = "border rounded bg-gray-50 p-2";

    const h = document.createElement("div");
    h.className = "text-blue-700 font-semibold mb-2";
    h.textContent = loc;
    blk.appendChild(h);

    Object.keys(report[loc].diseases).forEach(dn => {
      const e = report[loc].diseases[dn];

      const card = document.createElement("div");
      card.className = "bg-white p-3 rounded border relative";

      const close = document.createElement("button");
      close.className = "absolute right-2 top-2 text-red-500";
      close.textContent = "x";
      close.onclick = () => {
        delete report[loc].diseases[dn];
        if(!Object.keys(report[loc].diseases).length) delete report[loc];
        if(active && active.loc === loc && active.disease === dn){
          active = null;
          document.getElementById("detailsCard").classList.add("hidden");
        }
        renderReport();
        populateColumns();
        renderSubLocChips();
      };
      card.appendChild(close);

      const title = document.createElement("a");
      title.href = "#";
      title.className = "font-semibold text-sm";
      title.textContent = dn;
      title.onclick = e2 => {
        e2.preventDefault();
        openDetails(loc, dn);
        populateColumns();
      };
      card.appendChild(title);

      const meta = document.createElement("div");
      meta.className = "text-xs text-gray-600 mt-1";
      const subs = Array.isArray(e.sublocations) ? e.sublocations : [];
      meta.innerHTML = "<strong>Sub-Locations:</strong> " + (subs.length ? subs.join(", ") : "—");
      card.appendChild(meta);

      const ul = document.createElement("ul");
      ul.className = "list-disc pl-5 mt-2 text-xs text-gray-700";

      let any = false;
      Object.keys(e.sections || {}).forEach(sn => {
        const s = e.sections[sn];
        const hasAttrs = s.attrs && Object.keys(s.attrs).length > 0;
        const hasInputs = s.inputs && s.inputs.length > 0;
        const hasSubs = s.subsections && Object.keys(s.subsections).length > 0;
        if(!(hasAttrs || hasInputs || hasSubs)) return;

        any = true;
        const sli = document.createElement("li");
        sli.textContent = sn;

        const subul = document.createElement("ul");
        subul.className = "list-disc pl-6";

        Object.keys(s.attrs || {}).forEach(a => {
          const li = document.createElement("li");
          li.textContent = a;
          subul.appendChild(li);
        });

        (s.inputs || []).forEach(i => {
          const li = document.createElement("li");
          li.textContent = i.label;
          subul.appendChild(li);
        });

        Object.keys(s.subsections || {}).forEach(subn => {
          const sub = s.subsections[subn];
          const subli = document.createElement("li");
          subli.textContent = subn;

          const ssubul = document.createElement("ul");
          ssubul.className = "list-disc pl-6";

          Object.keys(sub.attrs || {}).forEach(a => {
            const li = document.createElement("li");
            li.textContent = a;
            ssubul.appendChild(li);
          });

          (sub.inputs || []).forEach(i => {
            const li = document.createElement("li");
            li.textContent = i.label;
            ssubul.appendChild(li);
          });

          if(ssubul.children.length) subli.appendChild(ssubul);
          subul.appendChild(subli);
        });

        if(subul.children.length) sli.appendChild(subul);
        ul.appendChild(sli);
      });

      if(e.comments){
        const cli = document.createElement("li");
        cli.textContent = "Comments: " + e.comments;
        ul.appendChild(cli);
        any = true;
      }

      if(any) card.appendChild(ul);
      blk.appendChild(card);
    });

    rc.appendChild(blk);
  });

  refreshLeftHighlights();
}

/* ---------- clear, download, load JSON ---------- */
document.getElementById("clearReport").onclick = () => {
  if(!confirm("Clear entire report?")) return;
  report = {};
  active = null;
  document.getElementById("detailsCard").classList.add("hidden");
  renderReport();
  populateColumns();
  renderSubLocChips();
  document.getElementById("csvNote").textContent = "Report cleared.";
};

document.getElementById("downloadJSON").onclick = () => {
  const out = JSON.parse(JSON.stringify(report || {}));
  if(active) out.__meta = { lastActive: active };
  const blob = new Blob([JSON.stringify(out,null,2)], {type:"application/json"});
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement("a");
  a.href = url;
  a.download = "endoscopy_report_" + new Date().toISOString().replace(/[:.]/g,"_") + ".json";
  a.click();
  URL.revokeObjectURL(url);
};

const jsonFileInput = document.getElementById("jsonFile");
document.getElementById("loadSavedJSON").onclick = () => jsonFileInput.click();

jsonFileInput.addEventListener("change", ev => {
  const f = ev.target.files[0];
  if(!f) return;
  const reader = new FileReader();
  reader.onload = () => {
    try{
      const parsedAll = JSON.parse(reader.result);
      if(typeof parsedAll !== "object" || parsedAll === null)
        throw new Error("Invalid JSON");

      let lastActive = null;
      if(parsedAll.__meta && parsedAll.__meta.lastActive){
        lastActive = parsedAll.__meta.lastActive;
        delete parsedAll.__meta;
      }

      report = parsedAll || {};

      Object.keys(report).forEach(loc => {
        const ds = report[loc].diseases || {};
        Object.keys(ds).forEach(dn => {
          const d = ds[dn];
          if(Array.isArray(d.sublocations)){
          } else if(typeof d.sublocation === "string" && d.sublocation){
            d.sublocations = [d.sublocation];
            delete d.sublocation;
          } else {
            d.sublocations = d.sublocations || [];
          }
        });
      });

      if(lastActive &&
         report[lastActive.loc] &&
         report[lastActive.loc].diseases &&
         report[lastActive.loc].diseases[lastActive.disease]){
        active = { loc: lastActive.loc, disease: lastActive.disease };
      } else {
        active = null;
        const locKeys = Object.keys(report);
        for(const loc of locKeys){
          const ds = report[loc].diseases || {};
          const dk = Object.keys(ds);
          if(dk.length){
            active = { loc, disease: dk[0] };
            break;
          }
        }
      }

      if(active) selectedMainLoc = active.loc;

      populateColumns();
      renderSubLocChips();
      renderReport();

      if(active){
        openDetails(active.loc, active.disease);
      } else {
        document.getElementById("detailsCard").classList.add("hidden");
      }

      document.getElementById("csvNote").textContent = "Report JSON loaded.";
    }catch(err){
      alert("Could not load JSON file: " + err.message);
    }
  };
  reader.readAsText(f);
  ev.target.value = "";
});

/* ---------- CSV upload & sample ---------- */
document.getElementById("csvFile").addEventListener("change", e => {
  const f = e.target.files[0];
  if(!f) return;
  const r = new FileReader();
  r.onload = () => {
    const rows = parseCSV(r.result);
    buildFromCSV(rows);
    populateColumns();
    renderSubLocChips();
    renderReport();
    document.getElementById("csvNote").textContent = "CSV loaded.";
  };
  r.readAsText(f);
});

document.getElementById("loadSample").onclick = () => {
  const sample = `Diagnosis,Section,Subsection,Default_Sub_Location,Conditional_on,Multi_Attribute,Default_Attr,Section_Hint,Subsection_Hint,Esophagus,GE Junction,Stomach,Duodenum,Attribute1,Attribute2,Attribute3
Suspected Barrett's Esophagus,Biopsy taken,,Lower,,single,,Biopsy taken for suspected Barrett's.\nThis can be multiline.,,x,,,,"Yes","No",
Suspected Barrett's Esophagus,Texture,,Lower,,multi,,Describe the texture.\nbarrett_texture.png,,x,,,,"Velvety","Granular","Irregular surface pattern"
Suspected Barrett's Esophagus,Prague Classification,,Lower,,single,,Enter Prague C/M length.,,x,,,,"Range(0,10)","Range(0,10)",
Caustic Injury,Substance Type,,Upper,,single,,Type of substance ingested.,,x,,,,"acid","alkali","oxidizer"
Caustic Injury,Time_since_ingestion,,Upper,,single,,Time elapsed since ingestion.,,x,,,,"int_box from int_box hours",,
`;
  const rows = parseCSV(sample);
  buildFromCSV(rows);
  populateColumns();
  renderSubLocChips();
  renderReport();
  document.getElementById("csvNote").textContent = "Sample loaded.";
};

/* ---------- init ---------- */
(function init(){
  populateColumns();
  renderSubLocChips();
  document.getElementById("csvNote").textContent = "Load your CSV or click Load sample.";
})();
</script>
</body>
</html>

